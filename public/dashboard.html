<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WhatsApp API Dashboard</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      color: #333;
    }
    header {
      background: #128C7E;
      padding: 15px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    header h1 {
      color: white;
      font-size: 24px;
      text-align: center;
    }
    nav {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .nav-btn {
      background: #25D366;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      transition: opacity 0.2s;
    }
    .nav-btn:hover { opacity: 0.9; }
    .nav-btn.active { background: #128C7E; }

    main {
      max-width: 750px;
      margin: 20px auto;
      padding: 0 20px;
    }
    .view {
      display: none;
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .view.active {
      display: block;
    }

    /* Formularios */
    input, button, select {
      padding: 10px;
      margin: 6px 0;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      background: #25D366;
      color: white;
      cursor: pointer;
      width: auto;
      display: inline-block;
    }
    .btn-warning { background: #ffaa00; }
    .btn-danger { background: #ff4d4d; }
    .btn-image { background: #4A90E2; }
    #qr-img {
      display: block;
      max-width: 300px;
      margin: 20px auto;
      border: 1px solid #eee;
    }
    .status { margin: 12px 0; font-weight: bold; min-height: 22px; padding: 8px; border-radius: 4px; }
    .connected { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }

    /* Tabla de sesiones */
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #f8f9fa; font-weight: bold; }
    .status-connected { color: green; font-weight: bold; }
    .status-qr { color: orange; }
    .status-error { color: red; }
    .action-btn {
      padding: 6px 10px;
      margin: 2px;
      font-size: 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .close-btn { background: #ff4d4d; color: white; }
  </style>
</head>
<body>
  <header>
    <h1>üì± WhatsApp API Dashboard</h1>
    <nav>
      <button class="nav-btn active" data-view="connect">Conectar</button>
      <button class="nav-btn" data-view="sessions">Sesiones</button>
      <button class="nav-btn" data-view="send">Enviar Texto</button>
      <button class="nav-btn" data-view="send-image">Enviar Imagen</button>
    </nav>
  </header>

  <main>
    <!-- Vista: Conectar -->
    <section id="connect-view" class="view active">
      <h2>Conectar nueva sesi√≥n</h2>
      <input type="text" id="sessionId" placeholder="Session ID (ej: cliente-123)" />
      <br />
      <button onclick="initSession()">Iniciar Sesi√≥n</button>
      <div id="status" class="status info">Ingresa un Session ID</div>
      
      <div id="session-controls" style="display:none; margin-top:15px;">
        <button class="btn-warning" onclick="restartSession()">üîÑ Reiniciar QR</button>
        <button class="btn-danger" onclick="closeSession()">‚ùå Cerrar Sesi√≥n</button>
      </div>

      <img id="qr-img" alt="QR Code" style="display:none;" />
    </section>

    <!-- Vista: Sesiones -->
    <section id="sessions-view" class="view">
      <h2>Sesiones activas</h2>
      <button onclick="loadSessions()" style="width:auto;">‚Üª Actualizar</button>
      <div id="sessions-list">
        <p>Cargando...</p>
      </div>
    </section>

    <!-- Vista: Enviar Texto -->
    <section id="send-view" class="view">
      <h2>Enviar mensaje de texto</h2>
      <p id="send-instructions">Conecta una sesi√≥n primero.</p>
      <div id="send-form" style="display:none;">
        <input type="text" id="send-sessionId" readonly placeholder="Session ID" />
        <input type="text" id="phone" placeholder="Tel√©fono (ej: 5491112345678)" />
        <input type="text" id="message" placeholder="Mensaje" />
        <button onclick="sendMessage()">Enviar WhatsApp</button>
        <div id="send-status" class="status" style="display:none;"></div>
      </div>
    </section>

    <!-- Vista: Enviar Imagen -->
    <section id="send-image-view" class="view">
      <h2>Enviar imagen</h2>
      <p id="image-instructions">Conecta una sesi√≥n primero.</p>
      <div id="image-form" style="display:none;">
        <input type="text" id="image-sessionId" readonly placeholder="Session ID" />
        <input type="text" id="image-phone" placeholder="Tel√©fono (ej: 5491112345678)" />
        <input type="text" id="image-caption" placeholder="Texto (opcional)" />
        <input type="file" id="image-file" accept="image/*,application/pdf,video/*,audio/*" />
        <button class="btn-image" onclick="sendImage()">üì§ Enviar Imagen</button>
        <div id="image-status" class="status" style="display:none;"></div>
      </div>
    </section>
  </main>

  <script>
    // ====== GESTI√ìN DE VISTAS ======
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(`${btn.dataset.view}-view`).classList.add('active');
        if (btn.dataset.view === 'sessions') loadSessions();
      });
    });

    // ====== VARIABLES GLOBALES ======
    let currentSessionId = null;
    let isConnected = false;

    // ====== FUNCI√ìN: Iniciar sesi√≥n ======
    async function initSession() {
      const sessionId = document.getElementById("sessionId").value?.trim();
      if (!sessionId) return alert("Ingresa un Session ID");
      currentSessionId = sessionId;
      showStatus("Iniciando sesi√≥n...", "info", "status");
      
      try {
        const res = await fetch("/api/whatsapp/init", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sessionId })
        });
        if (!res.ok) throw new Error("Error al iniciar");
        
        document.getElementById("session-controls").style.display = "block";
        document.getElementById("qr-img").style.display = "block";
        showStatus("‚è≥ Esperando QR...", "info", "status");
        startPolling();
        
        // Actualizar formularios
        document.getElementById("send-sessionId").value = sessionId;
        document.getElementById("image-sessionId").value = sessionId;
        document.getElementById("send-instructions").style.display = "none";
        document.getElementById("image-instructions").style.display = "none";
        document.getElementById("send-form").style.display = "block";
        document.getElementById("image-form").style.display = "block";
      } catch (err) {
        showStatus(`‚ùå Error: ${err.message}`, "error", "status");
      }
    }

    // ====== FUNCI√ìN: Mostrar estado ======
    function showStatus(text, type = "info", elementId = "status") {
      const el = document.getElementById(elementId);
      el.textContent = text;
      el.className = "status " + type;
      el.style.display = "block";
    }

    // ====== POLLING ======
    let pollInterval = null;
    function startPolling() {
      stopPolling();
      pollInterval = setInterval(checkSessionStatus, 3000);
      checkSessionStatus();
    }
    function stopPolling() {
      if (pollInterval) clearInterval(pollInterval);
    }
    async function checkSessionStatus() {
      if (!currentSessionId) return;
      try {
        const res = await fetch(`/api/whatsapp/session/${currentSessionId}/qr`);
        const data = await res.json();
        const img = document.getElementById("qr-img");
        
        if (data.status === "CONNECTED") {
          isConnected = true;
          showStatus("‚úÖ ¬°Conectado! Puedes enviar mensajes.", "connected", "status");
          img.style.display = "none";
        } else if (data.status === "QR_NEEDED") {
          img.src = `/api/whatsapp/session/${currentSessionId}/qr/image?_t=${Date.now()}`;
          img.style.display = "block";
          showStatus("üëá Escanea este c√≥digo con WhatsApp", "info", "status");
        } else {
          showStatus(`Estado: ${data.status}`, "error", "status");
          img.style.display = "none";
        }
      } catch (err) {
        console.error("Poll error:", err);
      }
    }

    // ====== SESI√ìN: Reiniciar / Cerrar ======
    async function restartSession() {
      if (!currentSessionId) return;
      showStatus("Reiniciando...", "info", "status");
      try {
        const res = await fetch("/api/whatsapp/restart", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sessionId: currentSessionId })
        });
        if (res.ok) {
          showStatus("Sesi√≥n reiniciada. Esperando nuevo QR...", "info", "status");
          isConnected = false;
          document.getElementById("qr-img").style.display = "block";
        }
      } catch (err) {
        showStatus(`‚ùå Error: ${err.message}`, "error", "status");
      }
    }

    async function closeSession() {
      if (!currentSessionId || !confirm("¬øCerrar sesi√≥n?")) return;
      try {
        const res = await fetch(`/api/whatsapp/session/${currentSessionId}`, { method: "DELETE" });
        if (res.ok) {
          stopPolling();
          currentSessionId = null;
          isConnected = false;
          document.getElementById("session-controls").style.display = "none";
          document.getElementById("qr-img").style.display = "none";
          document.getElementById("send-form").style.display = "none";
          document.getElementById("image-form").style.display = "none";
          document.getElementById("send-instructions").style.display = "block";
          document.getElementById("image-instructions").style.display = "block";
          showStatus("Sesi√≥n cerrada.", "info", "status");
        }
      } catch (err) {
        showStatus(`‚ùå Error: ${err.message}`, "error", "status");
      }
    }

    // ====== ENVIAR TEXTO ======
    async function sendMessage() {
      const phone = document.getElementById("phone").value?.trim();
      const message = document.getElementById("message").value?.trim();
      if (!phone || !message || !currentSessionId) {
        showStatus("Completa todos los campos", "error", "send-status");
        return;
      }
      
      showStatus("Enviando...", "info", "send-status");
      try {
        const res = await fetch("/api/whatsapp/send", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sessionId: currentSessionId, phone, message })
        });
        const result = await res.json();
        if (res.ok) {
          showStatus("‚úÖ ¬°Mensaje enviado!", "connected", "send-status");
          document.getElementById("phone").value = "";
          document.getElementById("message").value = "";
        } else {
          showStatus(`‚ùå ${result.error}`, "error", "send-status");
        }
      } catch (err) {
        showStatus(`‚ùå Error: ${err.message}`, "error", "send-status");
      }
    }

    // ====== ENVIAR IMAGEN ======
    async function sendImage() {
      const phone = document.getElementById("image-phone").value?.trim();
      const caption = document.getElementById("image-caption").value?.trim();
      const fileInput = document.getElementById("image-file");
      const file = fileInput.files[0];
      
      if (!phone || !file || !currentSessionId) {
        showStatus("Selecciona un archivo y completa el tel√©fono", "error", "image-status");
        return;
      }
      
      if (file.size > 16 * 1024 * 1024) {
        showStatus("‚ùå El archivo debe pesar menos de 16 MB", "error", "image-status");
        return;
      }
      
      showStatus("Procesando imagen...", "info", "image-status");
      
        // Convertir a base64
        const reader = new FileReader();
        reader.onload = async () => {
        const base64 = reader.result.split(",")[1]; // ‚úÖ CORRECTO
        const mimeType = file.type || "image/jpeg";
        const filename = file.name;
        
        try {
            const res = await fetch("/api/whatsapp/send-media", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                sessionId: currentSessionId,
                phone,
                caption,
                base64,
                mimeType,
                filename
            })
            });
            // ... resto del c√≥digo
        } catch (err) {
            showStatus(`‚ùå Error: ${err.message}`, "error", "image-status");
        }
        };
        reader.readAsDataURL(file);
    }

    // ====== LISTAR SESIONES ======
    async function loadSessions() {
      const container = document.getElementById("sessions-list");
      try {
        const res = await fetch("/api/whatsapp/sessions");
        const sessions = await res.json();
        
        if (sessions.length === 0) {
          container.innerHTML = "<p>No hay sesiones activas</p>";
          return;
        }
        
        let html = `
          <table>
            <thead>
              <tr>
                <th>Session ID</th>
                <th>Estado</th>
                <th>√öltima actualizaci√≥n</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        sessions.forEach(s => {
          const statusClass = 
            s.status === "CONNECTED" ? "status-connected" :
            s.status === "QR_NEEDED" ? "status-qr" : "status-error";
          const statusText = 
            s.status === "CONNECTED" ? "Conectado" :
            s.status === "QR_NEEDED" ? "Esperando QR" : s.status;
          
          html += `
            <tr>
              <td><strong>${s.id}</strong></td>
              <td class="${statusClass}">${statusText}</td>
              <td>${new Date(s.lastUpdated).toLocaleString()}</td>
              <td>
                <button class="action-btn close-btn" onclick="closeSessionFromList('${s.id}')">
                  ‚ùå Cerrar
                </button>
              </td>
            </tr>
          `;
        });
        
        html += `</tbody></table>`;
        container.innerHTML = html;
      } catch (err) {
        container.innerHTML = `<p class="status error">Error al cargar sesiones: ${err.message}</p>`;
      }
    }

    // ====== CERRAR SESI√ìN DESDE LISTA ======
    async function closeSessionFromList(sessionId) {
      if (!confirm(`¬øCerrar sesi√≥n "${sessionId}"?`)) return;
      try {
        const res = await fetch(`/api/whatsapp/session/${sessionId}`, { method: "DELETE" });
        if (res.ok) {
          alert("Sesi√≥n cerrada");
          loadSessions();
          // Si es la sesi√≥n actual, resetear
          if (currentSessionId === sessionId) {
            stopPolling();
            currentSessionId = null;
            isConnected = false;
            document.getElementById("session-controls").style.display = "none";
            document.getElementById("qr-img").style.display = "none";
            document.getElementById("send-form").style.display = "none";
            document.getElementById("image-form").style.display = "none";
            document.getElementById("send-instructions").style.display = "block";
            document.getElementById("image-instructions").style.display = "block";
            showStatus("Sesi√≥n cerrada.", "info", "status");
          }
        } else {
          alert("Error al cerrar sesi√≥n");
        }
      } catch (err) {
        alert("Error de red: " + err.message);
      }
    }
  </script>
</body>
</html>